<div style="flex: 1 1 0">
  <mat-toolbar>
    <mat-toolbar-row>
      <div style="font-size: 15px">
        <mat-form-field
          appearance="outline"
          style="margin: 20px 10px 0; padding: 0"
        >
          <mat-label>Quick filter</mat-label>
          <input
            matInput
            placeholder="gulas"
            [(ngModel)]="quickFilter"
            (ngModelChange)="changeFilter()"
          />
          <span matSuffix><mat-icon>filter_alt</mat-icon></span>
        </mat-form-field>
      </div>
      <div style="font-size: 15px">
        <mat-form-field
          appearance="outline"
          style="margin: 20px 10px 0; padding: 0"
        >
          <mat-label>Enter a date range</mat-label>
          <mat-date-range-input [formGroup]="range" [rangePicker]="picker">
            <input
              matStartDate
              formControlName="start"
              placeholder="Start date"
              (ngModelChange)="getOrders()"
            />
            <input
              matEndDate
              formControlName="end"
              placeholder="End date"
              (ngModelChange)="getOrders()"
            />
          </mat-date-range-input>
          <mat-datepicker-toggle
            matSuffix
            [for]="picker"
          ></mat-datepicker-toggle>
          <mat-date-range-picker
            #picker
            startView="year"
          ></mat-date-range-picker>
        </mat-form-field>

        <!-- <p>Selected range: {{range.value.start | date : 'd.M.y, HH:mm:ss'  }} Selected range: {{range.value.end | date : 'd.M.y, HH:mm:ss' }}</p> -->
      </div>
      <h2 class="table-title">Orders</h2>
      <span class="spacer"></span>
      <button mat-button [matMenuTriggerFor]="exportMenu">
        <mat-icon>file_download</mat-icon>
        Export table
      </button>
      <button mat-button (click)="createOrder()">
        <mat-icon>add</mat-icon>
        Create new order
      </button>
    </mat-toolbar-row>
  </mat-toolbar>

  <mat-menu #exportMenu="matMenu" [overlapTrigger]="false">
    <button mat-menu-item (click)="exportCSV(false)">
      Export entire table to CSV
    </button>
    <button mat-menu-item (click)="exportCSV(true)">
      Export visible data to CSV
    </button>
  </mat-menu>

  <table
    mat-table
    matSort
    [dataSource]="dataSource"
    multiTemplateDataRows
    class="mat-elevation-z8"
  >
    <ng-container matColumnDef="expand">
      <th mat-header-cell *matHeaderCellDef aria-label="row actions">&nbsp;</th>
      <td mat-cell *matCellDef="let element">
        <button
          mat-icon-button
          aria-label="expand row"
          (click)="
            expandedOrder = expandedOrder === element ? null : element;
            $event.stopPropagation()
          "
        >
          <mat-icon *ngIf="expandedOrder !== element"
            >keyboard_arrow_down</mat-icon
          >
          <mat-icon *ngIf="expandedOrder === element"
            >keyboard_arrow_up</mat-icon
          >
        </button>
      </td>
    </ng-container>

    <ng-container
      [matColumnDef]="column.field"
      *ngFor="let column of columnsToDisplay"
    >
      <th
        mat-header-cell
        *matHeaderCellDef
        mat-sort-header
        [style]="{ width: column.width || 'auto' }"
      >
        {{ column.header }}
      </th>
      <ng-container
        *ngIf="
          column.field === 'lastUpdate' || column.field === 'dueDate';
          else normalTd
        "
      >
        <td mat-cell *matCellDef="let element">
          {{ element[column.field] | date : "d.M.y, HH:mm:ss" : "UTC" }}
        </td>
      </ng-container>
      <ng-template #normalTd>
        <td mat-cell *matCellDef="let element">{{ element[column.field] }}</td>
      </ng-template>
    </ng-container>

    <ng-container matColumnDef="actions">
      <th
        mat-header-cell
        *matHeaderCellDef
        aria-label="row actions"
        style="width: 15%"
      >
        &nbsp;
      </th>
      <td mat-cell *matCellDef="let element">
        <button
          mat-icon-button
          color="primary"
          aria-label="Edit item"
          (click)="onEditClick(element)"
        >
          <mat-icon>visibility</mat-icon>
        </button>
        <button
          mat-icon-button
          color="primary"
          aria-label="PDF item"
          (click)="pdfClick(element)"
        >
          <mat-icon>file_download</mat-icon>
        </button>
        <button
          mat-icon-button
          color="danger"
          aria-label="Delete item"
          (click)="onDeleteClick(element)"
        >
          <mat-icon>delete_forever</mat-icon>
        </button>
        <button
          mat-icon-button
          [matMenuTriggerFor]="popup"
          *ngIf="!element.recipe.isValid"
        >
          <mat-icon style="color: red">flag</mat-icon>
        </button>
        <mat-menu #popup="matMenu">
          <p style="margin: 10px">Recipe in this order is no longer valid</p>
        </mat-menu>
      </td>
    </ng-container>

    <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
    <ng-container matColumnDef="expandedDetail">
      <td
        mat-cell
        *matCellDef="let element"
        [attr.colspan]="columnsToDisplayWithExpand.length"
      >
        <div
          class="default-element-detail"
          [@detailExpand]="element == expandedOrder ? 'expanded' : 'collapsed'"
          *ngIf="expandedOrder === element"
        >
          <div style="margin-top: 20px">
            <mat-form-field appearance="outline" style="width: 20%">
              <mat-label>Recipe ID</mat-label>
              <input
                matInput
                placeholder="0000000001"
                readonly
                [value]="element.recipe.id"
              />
            </mat-form-field>
            <mat-form-field appearance="outline" style="width: 30%">
              <mat-label>Recipe name</mat-label>
              <input
                matInput
                placeholder="gulas"
                readonly
                [value]="element.recipe.name"
              />
            </mat-form-field>
            <mat-form-field appearance="outline" style="width: 20%">
              <mat-label>Quantity</mat-label>
              <input
                matInput
                placeholder="250"
                readonly
                [value]="element.quantity"
              />
            </mat-form-field>
          </div>
          <div style="flex-direction: row; flex: 1 0 30%">
            <mat-list>
              <div style="width: 100%; display: flex">
                <div style="width: 50%; height: auto">
                  <h2>Components/Recipe</h2>
                </div>
                <div style="width: 50%; height: auto">
                  <h2>Components/Order</h2>
                </div>
              </div>
              <ng-container
                *ngFor="
                  let component of element.recipe.components;
                  let i = index
                "
              >
                <mat-list-item>
                  <div matLine>
                    <div style="width: 100%; display: flex">
                      <div style="width: 50%; height: auto">
                        <p style="float: left">
                          <mat-form-field
                            appearance="outline"
                            style="width: 20%"
                            class=" note" [ngClass]="{
                              gridC: i % 2 > 0
                            }"
                          >
                            <mat-label>ID</mat-label>
                            <input
                              matInput
                              placeholder="0000000001"
                              readonly
                              [value]="component.id"
                            />
                          </mat-form-field>
                          <mat-form-field
                            appearance="outline"
                            style="width: 250px"
                            class="note" [ngClass]="{
                              gridC: i % 2 > 0
                            }"
                          >
                            <mat-label>Name</mat-label>
                            <input
                              matInput
                              placeholder="0000000001"
                              readonly
                              [value]="component.name"
                            />
                          </mat-form-field>
                          <mat-form-field
                            appearance="outline"
                            style="width: 10%"
                            class="note" [ngClass]="{
                              gridC: i % 2 > 0
                            }"
                          >
                            <mat-label>Weight</mat-label>
                            <input
                              matInput
                              placeholder="0000000001"
                              readonly
                              [value]="component.componentSP.toFixed(3)"
                            />
                            <span matSuffix>KG</span>
                          </mat-form-field>
                          
                          <mat-form-field
                            appearance="outline"
                            style="width: 12%"
                            class="note" [ngClass]="{
                              gridC: i % 2 > 0
                            }"
                          >
                            <mat-label>Specific bulk weight</mat-label>
                            <input
                              matInput
                              placeholder="0000000001"
                              readonly
                              [value]="component.specificBulkWeight.toFixed(3)"
                            />
                            <span matSuffix>KG/L</span>
                          </mat-form-field>
                          <mat-form-field
                            appearance="outline"
                            style="width: 10%"
                            class="note" [ngClass]="{
                              gridC: i % 2 > 0
                            }"
                          >
                            <mat-label>Packing</mat-label>
                            <mat-select
                              [(ngModel)]="component.packingOrder"
                              [disabled]="component.packingOrder"
                              name="packingOrders"
                            >
                              <mat-option
                                *ngFor="let packingOrder of packingOrders"
                                [value]="packingOrder.value"
                              >
                                {{ packingOrder.viewValue }}
                              </mat-option>
                            </mat-select>
                          </mat-form-field>
                          <mat-form-field
                            appearance="outline"
                            style="width: 10%"
                            class="note" 
                            [ngClass]="{
                              hideItem: component.packingOrder > 0 ,
                              gridC: i % 2 > 0
                            }"
                          >
                            <mat-label>Packing</mat-label>
                            <input
                              matInput
                              placeholder="0000000001"
                              readonly
                              [value]="component.parkingWeight.toFixed(1)"
                            />
                            <span matSuffix>KG</span>
                          </mat-form-field>
                        </p>
                        <!-- <p style="margin: 0 0 0 1px;">W:{{component.componentSP.toFixed(3)}} kg |
                           P:{{component.packing.toFixed(1)}} |
                           SBW:{{component.specificBulkWeight.toFixed(3)}} kg/l 
                        </p> -->
                      </div>
                      <div style="width: 50%; height: auto">
                        <p style="float: left">
                          <mat-form-field
                            appearance="outline"
                            style="width: 20%"
                            class=" note"[ngClass]="{
                              gridC: i % 2 > 0
                            }"
                          >
                            <mat-label>ID</mat-label>
                            <input
                              matInput
                              placeholder="0000000001"
                              readonly
                              [value]="component.id"
                            />
                          </mat-form-field>
                          <mat-form-field
                            appearance="outline"
                            style="width: 250px"
                            class="note" [ngClass]="{
                              gridC: i % 2 > 0
                            }"
                          >
                            <mat-label>Name</mat-label>
                            <input
                              matInput
                              placeholder="0000000001"
                              readonly
                              [value]="component.name"
                            />
                          </mat-form-field>
                          <mat-form-field
                            appearance="outline"
                            style="width: 20%"
                            class="note" [ngClass]="{
                              gridC: i % 2 > 0
                            }"
                          >
                            <mat-label>Weight</mat-label>
                            <input
                              matInput
                              placeholder="0000000001"
                              readonly
                              [value]="component.componentSP * (element.quantity/100) |number :'1.3-3'"
                            />
                            <span matSuffix>KG</span>
                          </mat-form-field>
                        </p>
                      </div>
                    </div>
                  </div>
                </mat-list-item>
              </ng-container>

              <span
                style="margin: auto"
                *ngIf="element.recipe.components.length === 0"
                >No components in this recipe.</span
              >
            </mat-list>
          </div>
          <div style="flex-grow: 1">
            <mat-form-field appearance="outline" style="width: 20%">
              <mat-label>Mixer ID</mat-label>
              <!-- <input matInput placeholder="0000000001" readonly [value]="element.idMixer"> -->
              <mat-select [(ngModel)]="element.idMixer" [disabled]="true">
                <mat-option
                  *ngFor="let slecetIdMixer of slecetIdMixers"
                  [value]="slecetIdMixer.value"
                >
                  {{ slecetIdMixer.viewValue }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field appearance="outline" style="width: 20%">
              <mat-label>Mixing time</mat-label>
              <input
                matInput
                placeholder="100"
                readonly
                [value]="element.mixingTime"
              />
              <span matSuffix>min</span>
            </mat-form-field>
          </div>
          <div style="flex-grow: 1">
            <mat-form-field appearance="outline" style="width: 20%">
              <mat-label>Packing machine ID</mat-label>
              <input
                matInput
                placeholder="0000000001"
                readonly
                [value]="element.idPackingMachine"
              />
            </mat-form-field>
            <mat-form-field appearance="outline" style="width: 20%">
              <mat-label>Emptying station ID</mat-label>
              <input
                matInput
                placeholder="1"
                readonly
                [value]="element.idEmptyingStationBag"
              />
            </mat-form-field>
          </div>
          <div style="flex-grow: 1">
            <mat-form-field appearance="outline" style="width: 20%">
              <mat-label>Volume per Dose</mat-label>
              <input
                matInput
                placeholder="700.0"
                readonly
                [value]="element.volumePerDose"
              />
              <span matSuffix>L</span>
            </mat-form-field>
            <mat-form-field appearance="outline" style="width: 20%">
              <mat-label>Operator</mat-label>
              <input
                matInput
                placeholder="John"
                readonly
                [value]="
                  element.operator.firstName + ' ' + element.operator.lastName
                "
              />
            </mat-form-field>
          </div>
          <div style="flex-grow: 1; margin-bottom: 20px">
            <mat-form-field appearance="outline" style="width: 20%">
              <mat-label>Created at</mat-label>
              <input
                matInput
                readonly
                [value]="element.createdAt | date : 'd.M.y, HH:mm:ss' : 'UTC'"
              />
            </mat-form-field>
            <mat-form-field appearance="outline" style="width: 20%">
              <mat-label>Last update</mat-label>
              <input
                matInput
                readonly
                [value]="element.lastUpdate | date : 'd.M.y, HH:mm:ss' : 'UTC'"
              />
            </mat-form-field>
          </div>
        </div>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="columnsToDisplayWithExpand"></tr>
    <tr
      mat-row
      *matRowDef="let element; columns: columnsToDisplayWithExpand"
      class="default-element-row"
      [ngClass]="!element.recipe.isValid ? 'lightred-background' : ''"
      [class.default-expanded-row]="expandedOrder === element"
    ></tr>
    <tr
      mat-row
      *matRowDef="let row; columns: ['expandedDetail']"
      class="default-detail-row"
    ></tr>
    <tr class="mat-row" *matNoDataRow>
      <td class="mat-cell" colspan="4">
        No data matching the filter "{{ quickFilter }}".
      </td>
    </tr>
  </table>
  <div
    *ngIf="isLoading"
    style="
      display: flex;
      justify-content: center;
      align-items: center;
      background: white;
    "
  >
    <mat-progress-spinner color="primary" mode="indeterminate">
    </mat-progress-spinner>
  </div>
  <mat-paginator
    [length]="orders.length"
    [pageSizeOptions]="[10, 20, 50, 100]"
    [showFirstLastButtons]="true"
    [pageSize]="20"
    aria-label="Select page of orders search results"
  ></mat-paginator>
</div>
